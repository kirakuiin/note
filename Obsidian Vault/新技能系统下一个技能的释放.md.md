
# 场景

假设有这样一个场景对方释放龙雨卷击，攻击我方，并且把我的召唤兽打死了。下面将依据这个场景，梳理以下整个技能的表现流程。

![[1073.mp4]]

# 预处理阶段
## 从协议到指令

客户端的战斗系统本质上是服务端逻辑播放器，所有的表现内容本质上都和服务器的指令对应着。但是服务端的逻辑演算可能会在瞬间就完成，而客户端的表现可能要持续10多分钟，它们在时间上是不同步的。所以客户端的协议流对应着服务端的逻辑，而客户端的表现是由一个指令队列来驱动的。

![[新技能系统下一个技能的释放.md 2025-09-04 11.59.28.excalidraw]]

## 

下图是协议预处理之后的结果，协议是在客户端接收时是以线性关系排列的，处理之后会处理为树形结构，子节点即代表要和父节点同时触发的内容。

```text
perform magic_id=1073 attacker_id=3 victims=[2, 1] name= info=
    prop_change
    prop_change
    wstate victim_id=1 hurt=0 life=0 ward=0 hp_chg=635 hp_ext=0
    status id=1 status=77 eff_status=0
    summ_prop_state
    wstate victim_id=2 hurt=0 life=2 ward=0 hp_chg=1276 hp_ext=0
    status id=2 status=0 eff_status=0
    summ_prop_state
    summ_prop_state
    delete id=2 del_flash=0
```

当收到回合结束协议`manage_cmd()`来将零散的指令合并到一起，上图的协议就是经过合并后的龙雨卷击