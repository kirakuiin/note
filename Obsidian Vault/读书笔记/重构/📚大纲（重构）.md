---
outline: true
---
[[📚大纲（设计模式）|模式]]与重构之间存在着与生俱来的关系，模式是重构的目标，重构是达到目标的方法。

> [!hint]
> 如果你发现自己需要为程序添加一个特性，而代码结构无法使你很方便地达成目的，那就先重构那个程序，让特性易于添加，然后再添加特性。

> [!hint]
> 重构前，先检查自己是否有一套可靠的测试机制。这些测试必须有自我检验能力。

> [!hint]
> 重构技术就是以微小的步伐修改程序。如果你犯下错误，很容易便可发现它。

> [!hint]
> 任何一个傻瓜都能写出计算机可以理解的代码。唯有写出人类容易理解的代码，才是优秀的程序员。

# 重构原则

## 何为重构

重构就是在不改变软件可观察行为的前提下，提高其可理解性，降低其修改成本。

> [!quote]
> 添加新功能时，你不应该修改既有代码；重构时你只需改善程序结构，不要添加新功能。

## 为何重构

1. 重构改进了软件设计，消除了重复代码。
2. 重构使得代码更加容易理解，让扩充功能更加简单。
3. 重构的过程中会加深对代码的理解，更容易找到bug。
4. 重构之后提高了设计质量，而良好的设计是快速开发的根本，所以整体的开发速度会更快。

## 何时重构

重构不需要专门拨出时间来进行，重构应该随时随地进行。

- 添加功能时重构：当源代码难以增加功能时，进行重构。
- 修补错误时重构：因为代码还没清晰到让你一眼看出bug，所以需要重构。

> [!hint] 三次法则
> 第一次做时只管去做，第二次做类似的事会有反感，但还是去做，第三次再做类似的事则重构。

## 重构的难题

- 数据库：一般通过在对象模型和数据库模式中插入中间层来分隔两变的变化。
- 修改接口：如果你的接口没有公开发布，你可以随便修改，因为你有办法同时处理所有的调用处，否则最好保留旧接口并让其调用新的接口。
- 不该进行重构：当现有代码根本无法正常运行，你应该直接重写；当马上临近最后期限时，你也不该进行重构。

## 重构与设计

有了重构之后，你没必要找出一个完美的设计方案，只要实现一个相对合理的方案就够了。在不断的开发中根据需求进行重构，让方案更加完美。

重构可以带来更简单的设计，同时不损失灵活性，这降低了设计的压力。所以当下我们总是建造可运行的最小系统。

## 重构与性能

一般有三种做法：

1. 时间预算法：设计时对每个部分占用的时间都要做好预算，每个组件都不能超出自己的预算。这种只适用于要求极高的实时系统。
2. 持续关注法：写任何代码时都设法保持系统的高性能。但这种方式通常不会有太大的作用，因为90%时间都消耗在10%的代码上，你大部分的优化都是无用功。
3. 后期优化法：前期编写代码时主要维护代码的良好结构，可读性，不会关注性能。后期进入性能优化阶段，会寻找热点，对热点进行针对性的优化。

总体来说第三种是比较科学的性能优化方案。使用重构手法我们可以更快的开发程序，留出更多的时间寻找性能热点，而良好的代码结构使得更容易对性能进行优化。

# 代码的坏味道

何时重构代码？当你浏览代码时察觉到以下的“坏味道”，那么你就该进行重构了。

## 重复代码

如果你在一个以上的地点看到了相同的程序结构，那么可以肯定将它们合为一体会更好。

> [!summary] 相关重构手段
> - 最基础的手法是[[提炼函数|Extract Method]]。
> - 两个互为兄弟的子类内有重复代码，考虑[[函数上移|Pull Up Method]]，[[塑造函数模板|Form Template Method]]，[[替换算法|Substitute Algorithm]]。
> - 两个不相干的类出现重复代码，考虑[[提炼类|Extract Class]]。

## 过长函数

我们应当更加积极的分解函数。每当感觉应该用注释说点什么的时候，我们就需要把需要说明的内容放到一个独立函数里，并以其用途给它命名。

> [!summary] 相关重构手段
> - 最基础的手法是[[提炼函数|Extract Method]]。
> - 如果函数内有大量的临时变量和参数，使用[[以查询取代临时变量|Replace Temp with Query]]消除临时变量，使用[[引入参数对象|Introduce Parameter Object]]和[[保持对象完整|Preserve Whole Object]]来简化过长的参数列表。如果这样做完后还是有很多临时变量和参数，那么就用杀手锏[[以函数对象取代函数|Replace Method with Method Object]]。
> - 条件表达式也是提炼的信号，可以使用[[分解条件表达式|Decompose Conditional]]来处理。
> - 循环语句应该和其内容使用[[提炼函数|Extract Method]]放到一个新的函数中。

## 过大的类

如果想用单个类做太多的事情，其内往往就会出现很多实例变量。一旦如此，重复代码也就随之而来了。

> [!summary] 相关重构手段

## 过长参数列表

